

#include "openssl/rsa.h"
#include "openssl/bn.h"
#include "openssl/sha.h"
#include "openssl/evp.h"

unsigned int msg_obuf[] = {
0x47371004, 0xb8116f4, 0x36aa0266, 0xe660ec76, 0x43c037b6, 0x795c45a0, 0xe970e974, 0xa6446cab,
0x89a4ad1c, 0xfc015923, 0x52ad453d, 0xbaccfec5, 0x71206cd0, 0x94f03a4d, 0x9d7baaf0, 0x535999b7,
0xb8445b74, 0x3c1c8001, 0xdf170e78, 0x86991d28, 0xf407a718, 0x95b33890, 0xe9cc24f2, 0x5f861c62,
0xcce0f6d7, 0xcdb132f8, 0xc7e1ff6, 0xe040392e, 0x4384799a, 0x4e000126, 0x670d9474, 0x82def1fc,
0x6ccd99b2, 0x159f14d1, 0x5409149f, 0xefb857af, 0x3bfd8a4a, 0xd5e27436, 0x4dbe9fb4, 0x844294c5,
0x2d706ba5, 0x56cf8a25, 0x353c9040, 0x715fc94d, 0x57216440, 0xb00504e9, 0x8a8abf10, 0x97e475e7,
0x5e348e35, 0xdfdef3b0, 0x548783f9, 0x619340d2, 0xb4613fdb, 0xbcdf747a, 0xb236f426, 0x884bc70e,
0x842b18, 0x1d110e6e, 0xb24ba68b, 0x6f2d2b9c, 0xf39a7039, 0x7059a30b, 0x74fe3205, 0x1782e6a8,
0x435559d, 0xb11832b4, 0xf95ae458, 0x2f5e3247, 0xce1fce5d, 0xbbff3391, 0xbb2723a5, 0xd3efadf9,
0x261b8be9, 0x63b12486, 0x4163fe97, 0x1e5ac14d, 0xb0d3a09, 0xac58196b, 0x416a81d5, 0xbae1f5ea,
0x623a7293, 0xa34f02d6, 0x3e8bf46a, 0xc49cee79, 0x2a8c9c1c, 0xd5217aa8, 0x1c300849, 0x4adcc685,
0x2d761e68, 0x7d3e5a3d, 0x7b1dff79, 0x672c8880, 0xb9791d85, 0x1bab8b08, 0xa1fed7b0, 0x8e62948,
0x74eb71b8, 0x7cc254d1, 0x25ea7ce5, 0xc6e92a5b, 0x24c3c9f8, 0x4281359f, 0x7209b780, 0x5b0fe942,
0x5b0557c5, 0x9db8d298, 0x59dd63af, 0x485070f, 0x305c1a4a, 0x5bdfb0f2, 0x5a877d3a, 0x7a9ad782,
0xf2ce885f, 0x4aef7cc0, 0xd480b161, 0x325ec1fc, 0x95d96c1, 0x1c1294f6, 0xbe520251, 0x806deb7c,
0xf470e080, 0x226f4e02, 0xb355c86a, 0x874361d0, 0x62bf42ec,
};


unsigned int msg_obuf_pass[] = {
0x3bffc758, 0x8392f879, 0xc50a38b4, 0x186bdceb, 0xb3851718, 0x6bf41a2d, 0xc06762f1, 0x12791dc6,
0x76d8abe7, 0x3b0041de, 0xa535530d, 0x2330016e, 0xd9fc15cc, 0xecde065e, 0x90e9b90a, 0x98a87c36,
0xe7a81920, 0x331c036e, 0x7b7e1079, 0x2b1a5656, 0xe088fa2c, 0xe278182d, 0x5ccf5c7f, 0xe05db311,
0x1a7f7227, 0xa28abbb, 0xac59533c, 0xd7ff1723, 0x5b3d48fc, 0x85a23677, 0xcf995a9d, 0xd052bd8d,
0x9d46b505, 0xcaa28679, 0xad217d8b, 0xf18eac79, 0xa8108088, 0xd87a11b7, 0x5a01f278, 0x7bc8b83e,
0x4702b18e, 0x175757b0, 0x5e03b01c, 0x986b451a, 0xc9e8396e, 0x71eda765, 0x2710800, 0x9a3ef2d9,
0xc9251582, 0x58b8374d, 0x57b66e59, 0x6c54bf4a, 0x75cbed64, 0x4d2f8387, 0x95df1af3, 0xef47b98f,
0xa3e384af, 0xbcfe2182, 0xee2cfa2, 0x73bfaf1a, 0x75c3bcb2, 0x759a79a7, 0x4cefa93a, 0xb23fea8e,
0xa5f18117, 0x2e625004, 0x7aaada96, 0xe4d92001, 0x4943d80a, 0x8de8281, 0xd4974ff2, 0x3c33984f,
0xdcdc8b68, 0xa16df0da, 0x9b0c2169, 0x54624abf, 0xb8fe063b, 0x51b76d34, 0xb0eeb32, 0x2b255af2,
0xc07b54ed, 0xd564129a, 0xb536dc81, 0x6aa8c03b, 0x793c1853, 0x3be71088, 0x8def9745, 0x64c9053,
0x5f41a9fe, 0xa3e40eb, 0xf7b0048c, 0x8ae34181, 0xfbbc7eff, 0xee3520f4, 0xe6bf3760, 0x55d005f4,
0x4ec6358, 0xe079382c, 0xafbcda89, 0x4be4ca1e, 0xf5302dfa, 0x5c93a910, 0x38ee0ab7, 0xa46bc226,
0x10db0601, 0x4277b5eb, 0x63b3a5be, 0x91cf40a6, 0xa02ebfc1, 0x6093b296, 0x16464b41, 0x97224397,
0xd049cfc2, 0xfe548811, 0x572066ff, 0x1b7f35a3, 0x3c39b594, 0x54ed931c, 0xc3dbe3a1, 0xcb0fc39,
0x128839ea, 0xc18c4660, 0xa4836511, 0xfdc5103e, 0x83940b40,
};

unsigned int rsa_exp_obuf[] = {
0x4965795e, 0xf97976a5, 0xf40f4505, 0x7da4bd03, 0x33ded529, 0xacb8d863, 0x5e3feb97, 0xf37de855,
0x2d5c3be7, 0xd6366754, 0xcaf5461d, 0x7e3a8b2d, 0x793845dc, 0x5f71657e, 0xb1795e1c, 0xc5fecd40,
0x786bc1e1, 0x798e4e04, 0x79fc0af9, 0x60b35eb1, 0xc67b68e3, 0x4c71cbef, 0x5c79a7ba, 0x71d1817a,
0x132100e7, 0xe6955e2, 0xc309be75, 0x68c9a94f, 0x8d970e22, 0xe8f16e89, 0xd9d17a88, 0x28d35d09,
0x1c0b2578, 0xcc257347, 0xc6dab621, 0x37d05a24, 0x94c74614, 0x6f43e469, 0x3300de47, 0x72958f4d,
0x177168fa, 0x871a1266, 0x7eeff727, 0xf25835e0, 0x1356f4d, 0x3de296aa, 0x9c861351, 0xb6b7d079,
0x6586e864, 0x27ccbf50, 0xd4511f53, 0xddf5beca, 0xf987077, 0x796a8ee, 0x7a6a455f, 0x4f9c030d,
0xf306f629, 0x476c585d, 0x3a996d0, 0xc94ebb17, 0xcdace021, 0xfeb27878, 0x5351b281, 0x45981fa6,
};

unsigned int rsa_mod_obuf[] = {
0x603600a7, 0x54bddc65, 0xb4402a5a, 0x589415e1, 0x58944f11, 0x1fa7dedd, 0x88e02c3c, 0x57612909,
0x7e565e67, 0x598f27ee, 0xaa2a9a34, 0xfa4eb49d, 0xc9d46aa7, 0x4ec1537a, 0xf734e39f, 0x10c9b73d,
0xda284f47, 0x7b31ce3f, 0xeb1006fd, 0xf992bef7, 0x683efbaf, 0x641aeeda, 0xf229f34c, 0xd8399e73,
0xb2d86ff6, 0x8e718280, 0xc2f2a4b5, 0xca0acd3e, 0x9acd04b6, 0x73548b13, 0x8c542554, 0x677a98be,
0x4eb3daad, 0xa882fab3, 0x5698674a, 0xcd715457, 0xa3ed7f12, 0x8b6ac001, 0x88960324, 0x2a6697be,
0x83c953bc, 0x885a5106, 0xe4181365, 0xf16bed3a, 0xc84c5b61, 0xaec2f41e, 0x5f2d5e08, 0xa27f12f8,
0x1821bbfc, 0x40feda30, 0x2eca01fb, 0xddce0e37, 0x46828776, 0x8f773a0b, 0x2c0772c0, 0x861e9d7f,
0x2927ed5b, 0x629703df, 0x5bd344ef, 0x5e9cdb3d, 0xb4397b1b, 0x6b046d0b, 0x5f2cbbbb, 0x57ab3cf,
};

void DumpHex(unsigned char* label, unsigned char* buf, int len)
{
    int idx = 0;
    printf("===========================================\n");
    printf("            dump :%s\n", label);

    for (idx = 0 ; idx < len ; idx++)
    {
        printf("0x%.2x", buf[idx]);
        if (0 == (idx + 1) % 16)
            printf("\n");
        else
            printf(",");
    }
    printf("===========================================\n");
}

int main(int argc, char** argv)
{
    unsigned char*  p_mod = NULL;
    unsigned char*  p_priv = NULL;
    unsigned char*  p_msg = NULL;
    BIGNUM*         p_bn_mod = NULL;
    BIGNUM*         p_bn_priv = NULL;
    BIGNUM*         p_bn_pub = NULL;
    unsigned char   buf[256] = {0};
    int             ret = 0;
    SHA_CTX sha1;
    unsigned char*  padded[256] = {0};
    unsigned char*  hash[20] = {0};
    RSA*  pRSA = NULL;

    p_msg = (unsigned char*) msg_obuf;

    SHA1_Init(&sha1);
    SHA1_Update(&sha1, p_msg, 0x1f4);
    SHA1_Final(hash, &sha1);

    p_mod = (unsigned char*)rsa_mod_obuf;
    p_priv = (unsigned char*)rsa_exp_obuf;

    p_bn_mod = BN_bin2bn(p_mod, 256, NULL);
    if (NULL == p_bn_mod) {
        printf("%s, %d error\n", __FUNCTION__, __LINE__);
        return -1;
    }
    p_bn_priv = BN_bin2bn(p_priv, 256, NULL);
    if (NULL == p_bn_priv) {
        printf("%s, %d error\n", __FUNCTION__, __LINE__);
        return -1;
    }

    p_bn_pub = BN_new();
    BN_set_word(p_bn_pub, RSA_F4);

    pRSA = RSA_new();
    pRSA->n = BN_new();
    BN_copy(pRSA->n, p_bn_mod);

    pRSA->d = BN_new();
    BN_copy(pRSA->d, p_bn_priv);

    pRSA->e = BN_new();
    BN_copy(pRSA->e, p_bn_pub);

#if 0
    //RSA_check_key always fail
    ret = RSA_check_key(pRSA);
    if (ret) {
        printf("%s, %d error:%d\n", __FUNCTION__, __LINE__, ret);
        return -5;
    }
#endif

    ret = RSA_padding_add_PKCS1_PSS(pRSA, padded, hash, EVP_sha1(), 20);
    if (!ret) {
        printf("%s, %d error:%d\n", __FUNCTION__, __LINE__, ret);
        return -5;
    }

    DumpHex("padding", padded, 256);
    ret = RSA_private_encrypt(256, padded, buf, pRSA, RSA_NO_PADDING);
    if (256 != ret) {
        printf("%s, %d error:%d\n", __FUNCTION__, __LINE__, ret);
        return -10;
    }
    DumpHex("buf", buf, 256);

    return 0;
}
